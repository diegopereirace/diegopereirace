<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Monitor - Diego Pereira Portfolio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            min-height: 100vh;
            padding: 2rem;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #10b981, #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        .metric-card {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
        }
        .metric-card h3 {
            color: #10b981;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        .metric-label {
            color: #94a3b8;
            font-size: 0.875rem;
        }
        .good { color: #10b981; }
        .warning { color: #f59e0b; }
        .poor { color: #ef4444; }
        .status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 1rem;
        }
        .status.active {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        .status.inactive {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        .info {
            background: rgba(6, 182, 212, 0.1);
            border-left: 4px solid #06b6d4;
            padding: 1rem;
            margin-top: 2rem;
            border-radius: 8px;
        }
        button {
            background: linear-gradient(135deg, #10b981, #06b6d4);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ö° Performance Monitor</h1>
        <p style="color: #94a3b8; margin-bottom: 2rem;">Monitor em tempo real das m√©tricas de performance do portfolio</p>
        
        <div class="metrics-grid">
            <div class="metric-card">
                <h3>Service Worker</h3>
                <div class="metric-value" id="sw-status">Verificando...</div>
                <div class="metric-label">Status do cache offline</div>
                <span class="status" id="sw-badge">Verificando</span>
            </div>
            
            <div class="metric-card">
                <h3>First Contentful Paint</h3>
                <div class="metric-value" id="fcp">-</div>
                <div class="metric-label">Tempo at√© primeiro conte√∫do</div>
            </div>
            
            <div class="metric-card">
                <h3>Largest Contentful Paint</h3>
                <div class="metric-value" id="lcp">-</div>
                <div class="metric-label">Tempo at√© maior elemento</div>
            </div>
            
            <div class="metric-card">
                <h3>First Input Delay</h3>
                <div class="metric-value" id="fid">-</div>
                <div class="metric-label">Lat√™ncia de interatividade</div>
            </div>
            
            <div class="metric-card">
                <h3>Cumulative Layout Shift</h3>
                <div class="metric-value" id="cls">-</div>
                <div class="metric-label">Estabilidade visual</div>
            </div>
            
            <div class="metric-card">
                <h3>Total Blocking Time</h3>
                <div class="metric-value" id="tbt">-</div>
                <div class="metric-label">Tempo de bloqueio</div>
            </div>
            
            <div class="metric-card">
                <h3>Resources Cached</h3>
                <div class="metric-value" id="cached-count">0</div>
                <div class="metric-label">Recursos em cache</div>
            </div>
            
            <div class="metric-card">
                <h3>Page Load Time</h3>
                <div class="metric-value" id="load-time">-</div>
                <div class="metric-label">Tempo total de carregamento</div>
            </div>
        </div>
        
        <div class="info">
            <h3 style="margin-bottom: 0.5rem;">üìä Core Web Vitals - Metas</h3>
            <ul style="list-style: none; padding-left: 0; color: #cbd5e1;">
                <li>‚úÖ FCP: < 1.8s (Bom), < 3.0s (Precisa melhorar)</li>
                <li>‚úÖ LCP: < 2.5s (Bom), < 4.0s (Precisa melhorar)</li>
                <li>‚úÖ FID: < 100ms (Bom), < 300ms (Precisa melhorar)</li>
                <li>‚úÖ CLS: < 0.1 (Bom), < 0.25 (Precisa melhorar)</li>
                <li>‚úÖ TBT: < 200ms (Bom), < 600ms (Precisa melhorar)</li>
            </ul>
        </div>
        
        <button onclick="clearCache()">üóëÔ∏è Limpar Cache do Service Worker</button>
        <button onclick="location.reload()">üîÑ Recarregar P√°gina</button>
    </div>
    
    <script>
        // Verificar Service Worker
        async function checkServiceWorker() {
            const statusEl = document.getElementById('sw-status');
            const badgeEl = document.getElementById('sw-badge');
            
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    
                    if (registration) {
                        // Verificar todos os estados poss√≠veis
                        const isActive = registration.active !== null;
                        const isInstalling = registration.installing !== null;
                        const isWaiting = registration.waiting !== null;
                        
                        console.log('[Monitor] SW Status:', { isActive, isInstalling, isWaiting });
                        
                        if (isActive) {
                            statusEl.textContent = 'Ativo ‚úì';
                            statusEl.className = 'metric-value good';
                            badgeEl.textContent = 'Ativo';
                            badgeEl.className = 'status active';
                            
                            // Contar recursos em cache
                            try {
                                const cacheNames = await caches.keys();
                                let totalCached = 0;
                                for (const name of cacheNames) {
                                    const cache = await caches.open(name);
                                    const keys = await cache.keys();
                                    totalCached += keys.length;
                                }
                                console.log('[Monitor] Cached resources:', totalCached);
                                document.getElementById('cached-count').textContent = totalCached;
                            } catch (cacheErr) {
                                console.error('[Monitor] Error counting cache:', cacheErr);
                            }
                        } else if (isInstalling) {
                            statusEl.textContent = 'Instalando...';
                            statusEl.className = 'metric-value warning';
                            badgeEl.textContent = 'Instalando';
                            badgeEl.className = 'status inactive';
                        } else if (isWaiting) {
                            statusEl.textContent = 'Aguardando';
                            statusEl.className = 'metric-value warning';
                            badgeEl.textContent = 'Aguardando';
                            badgeEl.className = 'status inactive';
                        } else {
                            statusEl.textContent = 'Registrado';
                            statusEl.className = 'metric-value warning';
                            badgeEl.textContent = 'Registrado';
                            badgeEl.className = 'status inactive';
                        }
                    } else {
                        statusEl.textContent = 'Inativo ‚úó';
                        statusEl.className = 'metric-value poor';
                        badgeEl.textContent = 'Inativo';
                        badgeEl.className = 'status inactive';
                    }
                } catch (err) {
                    console.error('[Monitor] Error checking SW:', err);
                    statusEl.textContent = 'Erro';
                    statusEl.className = 'metric-value poor';
                    badgeEl.textContent = 'Erro';
                    badgeEl.className = 'status inactive';
                }
            } else {
                statusEl.textContent = 'N√£o suportado';
                statusEl.className = 'metric-value warning';
                badgeEl.textContent = 'N√£o suportado';
                badgeEl.className = 'status inactive';
            }
        }
        
        // Performance Observer para Core Web Vitals
        function observePerformance() {
            // FCP
            new PerformanceObserver((list) => {
                const entries = list.getEntries();
                const fcp = entries[0];
                const fcpValue = (fcp.startTime / 1000).toFixed(2);
                const fcpEl = document.getElementById('fcp');
                fcpEl.textContent = `${fcpValue}s`;
                fcpEl.className = `metric-value ${fcpValue < 1.8 ? 'good' : fcpValue < 3.0 ? 'warning' : 'poor'}`;
            }).observe({ entryTypes: ['paint'] });
            
            // LCP
            new PerformanceObserver((list) => {
                const entries = list.getEntries();
                const lastEntry = entries[entries.length - 1];
                const lcpValue = (lastEntry.renderTime || lastEntry.loadTime) / 1000;
                const lcpEl = document.getElementById('lcp');
                lcpEl.textContent = `${lcpValue.toFixed(2)}s`;
                lcpEl.className = `metric-value ${lcpValue < 2.5 ? 'good' : lcpValue < 4.0 ? 'warning' : 'poor'}`;
            }).observe({ entryTypes: ['largest-contentful-paint'] });
            
            // FID
            new PerformanceObserver((list) => {
                const entries = list.getEntries();
                const fid = entries[0];
                const fidValue = fid.processingStart - fid.startTime;
                const fidEl = document.getElementById('fid');
                fidEl.textContent = `${fidValue.toFixed(0)}ms`;
                fidEl.className = `metric-value ${fidValue < 100 ? 'good' : fidValue < 300 ? 'warning' : 'poor'}`;
            }).observe({ entryTypes: ['first-input'] });
            
            // Fallback para FID se n√£o houver intera√ß√£o em 5s
            setTimeout(() => {
                const fidEl = document.getElementById('fid');
                if (fidEl.textContent === '-') {
                    fidEl.textContent = '0ms';
                    fidEl.className = 'metric-value good';
                }
            }, 5000);
            
            // CLS
            let clsValue = 0;
            new PerformanceObserver((list) => {
                for (const entry of list.getEntries()) {
                    if (!entry.hadRecentInput) {
                        clsValue += entry.value;
                    }
                }
                const clsEl = document.getElementById('cls');
                clsEl.textContent = clsValue.toFixed(3);
                clsEl.className = `metric-value ${clsValue < 0.1 ? 'good' : clsValue < 0.25 ? 'warning' : 'poor'}`;
            }).observe({ entryTypes: ['layout-shift'] });
        }
        
        // Page Load Time
        window.addEventListener('load', () => {
            // Usar Navigation Timing API Level 2
            const perfData = performance.getEntriesByType('navigation')[0];
            
            if (perfData) {
                const loadTime = (perfData.loadEventEnd - perfData.fetchStart) / 1000;
                const loadEl = document.getElementById('load-time');
                
                if (loadTime > 0) {
                    loadEl.textContent = `${loadTime.toFixed(2)}s`;
                    loadEl.className = `metric-value ${loadTime < 2 ? 'good' : loadTime < 4 ? 'warning' : 'poor'}`;
                } else {
                    // Aguardar loadEventEnd estar dispon√≠vel
                    setTimeout(() => {
                        const updatedLoadTime = (performance.getEntriesByType('navigation')[0].loadEventEnd - perfData.fetchStart) / 1000;
                        loadEl.textContent = `${updatedLoadTime.toFixed(2)}s`;
                        loadEl.className = `metric-value ${updatedLoadTime < 2 ? 'good' : updatedLoadTime < 4 ? 'warning' : 'poor'}`;
                    }, 100);
                }
                
                // TBT aproximado usando domContentLoadedEventEnd
                const tbt = perfData.domContentLoadedEventEnd - perfData.domLoading;
                const tbtEl = document.getElementById('tbt');
                
                if (!isNaN(tbt) && tbt > 0) {
                    tbtEl.textContent = `${Math.round(tbt)}ms`;
                    tbtEl.className = `metric-value ${tbt < 200 ? 'good' : tbt < 600 ? 'warning' : 'poor'}`;
                } else {
                    // Fallback: usar tempo entre domLoading e domComplete
                    const fallbackTbt = perfData.domComplete - perfData.domLoading;
                    if (!isNaN(fallbackTbt) && fallbackTbt > 0) {
                        tbtEl.textContent = `${Math.round(fallbackTbt)}ms`;
                        tbtEl.className = `metric-value ${fallbackTbt < 200 ? 'good' : fallbackTbt < 600 ? 'warning' : 'poor'}`;
                    } else {
                        tbtEl.textContent = '0ms';
                        tbtEl.className = 'metric-value good';
                    }
                }
            } else {
                // Fallback para API antiga se necess√°rio
                const loadTime = (performance.timing.loadEventEnd - performance.timing.navigationStart) / 1000;
                if (loadTime > 0) {
                    const loadEl = document.getElementById('load-time');
                    loadEl.textContent = `${loadTime.toFixed(2)}s`;
                    loadEl.className = `metric-value ${loadTime < 2 ? 'good' : loadTime < 4 ? 'warning' : 'poor'}`;
                }
                
                // TBT fallback
                const tbt = performance.timing.domContentLoadedEventEnd - performance.timing.domLoading;
                const tbtEl = document.getElementById('tbt');
                if (!isNaN(tbt) && tbt > 0) {
                    tbtEl.textContent = `${tbt}ms`;
                    tbtEl.className = `metric-value ${tbt < 200 ? 'good' : tbt < 600 ? 'warning' : 'poor'}`;
                } else {
                    tbtEl.textContent = '0ms';
                    tbtEl.className = 'metric-value good';
                }
            }
        });
        
        // Limpar cache
        async function clearCache() {
            if ('serviceWorker' in navigator) {
                const cacheNames = await caches.keys();
                await Promise.all(cacheNames.map(name => caches.delete(name)));
                alert('‚úÖ Cache limpo com sucesso!');
                location.reload();
            }
        }
        
        // Inicializar
        checkServiceWorker();
        observePerformance();
        
        // For√ßar registro do Service Worker
        if ('serviceWorker' in navigator) {
            // Verificar se o ambiente suporta SW
            const isSecureContext = location.protocol === 'https:' || 
                                   location.hostname === 'localhost' || 
                                   location.hostname === '127.0.0.1' ||
                                   location.hostname.includes('.ddev.site') ||
                                   location.hostname.includes('.local');
            
            if (isSecureContext) {
                navigator.serviceWorker.register('/assets/js/sw.js')
                    .then(registration => {
                        console.log('[Monitor] Service Worker registrado:', registration.scope);
                        
                        // For√ßar ativa√ß√£o imediata
                        if (registration.waiting) {
                            registration.waiting.postMessage({ action: 'skipWaiting' });
                        }
                        
                        // Recarregar status ap√≥s registro
                        setTimeout(checkServiceWorker, 1000);
                        setTimeout(checkServiceWorker, 3000);
                    })
                    .catch(err => {
                        console.error('[Monitor] Erro ao registrar Service Worker:', err);
                    });
            } else {
                console.warn('[Monitor] Service Worker requer contexto seguro (HTTPS/localhost)');
            }
        }
        
        // Atualizar Service Worker status a cada 3s
        setInterval(checkServiceWorker, 3000);
    </script>
</body>
</html>
